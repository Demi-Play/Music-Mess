{% extends 'base.html' %}

{% block title %}–ß–∞—Ç –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞: {{ chat.project.name }}{% endblock %}

{% block content %}
<h2>–ß–∞—Ç –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞: {{ chat.project.name }}</h2>

<div class="message-container">
    <ul class="list-group mb-3" id="messageList">
        {% for message in messages %}
        <li class="list-group-item" id="message-{{ message.id }}">
            <strong>{{ message.sender.username }}:</strong> 
            <span class="message-content">{{ message.content }}</span> 
            <span class="timestamp">({{ message.created_at }})</span>
            {% if message.sender == user %}
                <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                <button class="btn btn-link edit-message" data-id="{{ message.id }}" data-content="{{ message.content }}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <!-- –§–æ—Ä–º–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
                <form method="post" action="{% url 'chat:delete_message' message.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-link text-danger">–£–¥–∞–ª–∏—Ç—å</button>
                </form>
            {% endif %}
        </li>
        {% endfor %}
    </ul>
</div>

<style>
    .message-container {
        max-height: 450px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
        overflow-y: auto; /* –î–æ–±–∞–≤–ª—è–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
        border: 1px solid #ccc; /* –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–º–∫—É –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–µ–Ω–∏—è */
        padding: 10px; /* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø—ã */
        margin-bottom: 20px; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
    }
</style>

<!-- –§–æ—Ä–º–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
<form id="messageForm" method="post">
    {% csrf_token %}
    <input type="text" name="content" id="newMessageContent" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required />
    <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#emojiModal">–í—ã–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏</button>
    <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
</form>

<a href="{% url 'chat:chat_list' %}" class="btn btn-secondary mt-3">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É —á–∞—Ç–æ–≤</a>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
<div class="modal fade" id="editMessageModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editMessageForm" method="post">
                    {% csrf_token %}
                    <input type="hidden" id="editMessageId" name="message_id">
                    <textarea id="editMessageContent" name="content" rows="4"></textarea>
                    <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#emojiModalEdit">–í—ã–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏</button>
                    <button type="submit" class="btn btn-primary mt-2">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ —ç–º–æ–¥–∑–∏ -->
<div class="modal fade" id="emojiModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ–¥–∑–∏</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <button class='emoji-picker2' data-emoji='üòä'>üòä</button>
                <button class='emoji-picker2' data-emoji='üò¢'>üò¢</button>
                <button class='emoji-picker2' data-emoji='üòÇ'>üòÇ</button>
                <button class='emoji-picker2' data-emoji='üò°'>üò°</button>
                <button class='emoji-picker2' data-emoji='üòç'>üòç</button>
                <button class='emoji-picker2' data-emoji='üòé'>üòé</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ —ç–º–æ–¥–∑–∏ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ -->
<div class="modal fade" id="emojiModalEdit" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class='modal-title'>–í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ–¥–∑–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h5>
                <button type='button' class='close' data-dismiss='modal' aria-label='Close'>
                    <span aria-hidden='true'>&times;</span>
                </button>
            </div>
            <div class='modal-body'>
                <!-- –≠–º–æ–¥–∑–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                <button class='emoji-picker1' data-emoji='üòä'>üòä</button>
                <button class='emoji-picker1' data-emoji='üò¢'>üò¢</button>
                <button class='emoji-picker1' data-emoji='üòÇ'>üòÇ</button>
                <button class='emoji-picker1' data-emoji='üò°'>üò°</button>
                <button class='emoji-picker1' data-emoji='üòç'>üòç</button>
                <button class='emoji-picker1' data-emoji='üòé'>üòé</button>
            </div>
        </div>
    </div>
</div>

<script>
// –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π
document.querySelectorAll('.edit-message').forEach(button => {
    button.onclick = function () {
        const messageId = this.getAttribute('data-id');
        const messageContent = this.getAttribute('data-content');
        
        document.getElementById('editMessageId').value = messageId;
        document.getElementById('editMessageContent').value = messageContent;
        $('#editMessageModal').modal('show');
    };
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
document.getElementById('editMessageForm').onsubmit = function (event) {
    event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã

    const formData = new FormData(this);
    const messageId = document.getElementById('editMessageId').value;

    fetch(`/chat/messages/${messageId}/edit/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        }
    }).then(response => {
        if (response.ok) {
            return response.json();
        }
    }).then(data => {
        if (data.success) {
            const messageItem = document.getElementById(`message-${messageId}`);
            messageItem.querySelector('.message-content').innerText = data.new_content;
            $('#editMessageModal').modal('hide'); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        }
    });
};

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –≤—ã–±–æ—Ä–∞ —ç–º–æ–¥–∑–∏

document.querySelectorAll('.emoji-picker1').forEach(picker => {
    picker.onclick = function () {
        const emoji = this.getAttribute('data-emoji');
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–¥–µ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è (–≤ —Ñ–æ—Ä–º–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        const inputField = document.activeElement === document.getElementById('editMessageContent') 
                            ? document.getElementById('newMessageContent') 
                            : document.getElementById('editMessageContent');
        
        inputField.value += emoji; // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–º–æ–¥–∑–∏ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        $('#emojiModal').modal('hide'); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Å–º–∞–π–ª–æ–≤
    };
});

document.querySelectorAll('.emoji-picker2').forEach(picker => {
    picker.onclick = function () {
        const emoji = this.getAttribute('data-emoji');
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–¥–µ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è (–≤ —Ñ–æ—Ä–º–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        const inputField = document.activeElement === document.getElementById('newMessageContent') 
                            ? document.getElementById('editMessageContent') 
                            : document.getElementById('newMessageContent');
        
        inputField.value += emoji; // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–º–æ–¥–∑–∏ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        $('#emojiModal').modal('hide'); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Å–º–∞–π–ª–æ–≤
    };
});
</script>

{% endblock %}